<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Users Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="firebase-config.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        orderBy,
        limit,
        startAfter,
        where,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(window.firebaseConfig);
      const db = getFirestore(app);

      window.db = db;
      window.firestore = {
        collection,
        getDocs,
        query,
        orderBy,
        limit,
        startAfter,
        where,
      };
    </script>
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .loading {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            Firebase Configuration
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Please update the Firebase configuration with your project details.
          </p>

          <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <h4 class="text-sm font-semibold text-blue-800 mb-2">
              Where to find these values:
            </h4>
            <ul class="text-xs text-blue-700 space-y-1">
              <li>
                • Go to
                <a
                  href="https://console.firebase.google.com"
                  class="underline"
                  target="_blank"
                  >Firebase Console</a
                >
              </li>
              <li>• Select your project</li>
              <li>• Click the gear icon ⚙️ → Project settings</li>
              <li>• Scroll to "Your apps" section</li>
              <li>• Click "Config" under your web app</li>
            </ul>
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >API Key</label
              >
              <input
                type="text"
                id="apiKeyInput"
                placeholder="AIzaSy..."
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Auth Domain</label
              >
              <input
                type="text"
                id="authDomainInput"
                placeholder="your-project.firebaseapp.com"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Project ID</label
              >
              <input
                type="text"
                id="projectIdInput"
                placeholder="your-project-id"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Storage Bucket</label
              >
              <input
                type="text"
                id="storageBucketInput"
                placeholder="your-project.appspot.com"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Messaging Sender ID</label
              >
              <input
                type="text"
                id="messagingSenderIdInput"
                placeholder="123456789"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >App ID</label
              >
              <input
                type="text"
                id="appIdInput"
                placeholder="1:123456789:web:..."
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
              />
            </div>
          </div>
          <div class="mt-6 flex justify-end space-x-3">
            <button
              id="skipConfig"
              class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Skip (Use Demo)
            </button>
            <button
              id="saveConfig"
              class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
            >
              Connect
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="gradient-bg rounded-lg p-6 mb-8 text-white">
        <h1 class="text-3xl font-bold mb-2">Firebase Users Dashboard</h1>
        <p class="text-blue-100">Manage and view all registered users</p>
        <div id="connectionStatus" class="mt-2 text-sm">
          <span
            class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-200 text-yellow-800"
          >
            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
            Not Connected
          </span>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-500 text-white mr-4">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                ></path>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Users</p>
              <p id="totalUsers" class="text-2xl font-bold text-gray-800">0</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-500 text-white mr-4">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Subscribed Users</p>
              <p id="subscribedUsers" class="text-2xl font-bold text-gray-800">
                0
              </p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-500 text-white mr-4">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Active Today</p>
              <p id="activeToday" class="text-2xl font-bold text-gray-800">0</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                ></path>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">New This Week</p>
              <p id="newThisWeek" class="text-2xl font-bold text-gray-800">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Search Users</label
            >
            <input
              type="text"
              id="searchInput"
              placeholder="Search by name, email..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Subscription</label
            >
            <select
              id="subscriptionFilter"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Users</option>
              <option value="true">Subscribed</option>
              <option value="false">Free Users</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Subscription Type</label
            >
            <select
              id="subscriptionTypeFilter"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Types</option>
              <option value="FREE">Free</option>
              <option value="PREMIUM">Premium</option>
              <option value="LIFETIME">Lifetime</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Date Range</label
            >
            <select
              id="dateFilter"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>

        <div class="flex justify-between items-center">
          <button
            id="clearFilters"
            class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200"
          >
            Clear Filters
          </button>
          <div class="flex space-x-2">
            <button
              id="refreshData"
              class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200"
            >
              <svg
                class="w-4 h-4 inline mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
              Refresh
            </button>
            <button
              id="exportData"
              class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200"
            >
              <svg
                class="w-4 h-4 inline mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              Export CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div
        id="loadingState"
        class="bg-white rounded-lg shadow-md p-8 text-center hidden"
      >
        <div
          class="loading w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"
        ></div>
        <p class="text-gray-600">Loading users...</p>
      </div>

      <!-- Error State -->
      <div
        id="errorState"
        class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6 hidden"
      >
        <div class="flex">
          <svg
            class="w-5 h-5 text-red-400 mt-0.5 mr-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
            ></path>
          </svg>
          <div>
            <h3 class="text-sm font-medium text-red-800">Connection Error</h3>
            <p id="errorMessage" class="text-sm text-red-700 mt-1"></p>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div
        id="usersTable"
        class="bg-white rounded-lg shadow-md overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  User
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Contact
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Subscription
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Device
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Activity
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="usersTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Users will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div
        id="pagination"
        class="bg-white rounded-lg shadow-md p-4 mt-6 flex items-center justify-between"
      >
        <div class="text-sm text-gray-700">
          Showing <span id="showingStart">0</span> to
          <span id="showingEnd">0</span> of
          <span id="showingTotal">0</span> users
        </div>
        <div class="flex items-center space-x-2">
          <button
            id="prevPage"
            class="px-3 py-1 text-sm bg-gray-200 text-gray-600 rounded-md hover:bg-gray-300 disabled:opacity-50"
            disabled
          >
            Previous
          </button>
          <div id="pageNumbers" class="flex space-x-1">
            <!-- Page numbers will be inserted here -->
          </div>
          <button
            id="nextPage"
            class="px-3 py-1 text-sm bg-gray-200 text-gray-600 rounded-md hover:bg-gray-300 disabled:opacity-50"
            disabled
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- User Details Modal -->
    <div
      id="userModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">User Details</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <div id="userModalContent">
            <!-- User details will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let allUsers = [];
      let filteredUsers = [];
      let currentPage = 1;
      const itemsPerPage = 10;
      let isConnected = false;

      // Initialize the dashboard
      document.addEventListener("DOMContentLoaded", function () {
        setupEventListeners();
        checkFirebaseConnection();
      });

      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", filterUsers);
        document
          .getElementById("subscriptionFilter")
          .addEventListener("change", filterUsers);
        document
          .getElementById("subscriptionTypeFilter")
          .addEventListener("change", filterUsers);
        document
          .getElementById("dateFilter")
          .addEventListener("change", filterUsers);
        document
          .getElementById("clearFilters")
          .addEventListener("click", clearFilters);
        document
          .getElementById("refreshData")
          .addEventListener("click", refreshData);
        document
          .getElementById("exportData")
          .addEventListener("click", exportToCSV);
        document
          .getElementById("prevPage")
          .addEventListener("click", () => changePage(currentPage - 1));
        document
          .getElementById("nextPage")
          .addEventListener("click", () => changePage(currentPage + 1));
        document
          .getElementById("closeModal")
          .addEventListener("click", closeModal);
        document
          .getElementById("saveConfig")
          .addEventListener("click", saveConfig);
        document
          .getElementById("skipConfig")
          .addEventListener("click", skipConfig);
      }

      // Configuration Modal Functions
      function saveConfig() {
        const apiKey = document.getElementById("apiKeyInput").value.trim();
        const authDomain = document
          .getElementById("authDomainInput")
          .value.trim();
        const projectId = document
          .getElementById("projectIdInput")
          .value.trim();
        const storageBucket = document
          .getElementById("storageBucketInput")
          .value.trim();
        const messagingSenderId = document
          .getElementById("messagingSenderIdInput")
          .value.trim();
        const appId = document.getElementById("appIdInput").value.trim();

        if (!apiKey || !authDomain || !projectId) {
          alert("Please fill in at least API Key, Auth Domain, and Project ID");
          return;
        }

        // You would need to reinitialize Firebase with new config here
        // For now, we'll just close the modal and show a message
        alert(
          "Configuration saved! Note: You need to refresh the page for changes to take effect."
        );
        document.getElementById("configModal").style.display = "none";

        // Store config in localStorage for persistence
        const newConfig = {
          apiKey,
          authDomain,
          projectId,
          storageBucket: storageBucket || `${projectId}.appspot.com`,
          messagingSenderId,
          appId,
        };

        localStorage.setItem("firebaseConfig", JSON.stringify(newConfig));
      }

      function skipConfig() {
        document.getElementById("configModal").style.display = "none";
        // Load demo data
        loadDemoData();
      }

      // Modal Functions
      function closeModal() {
        document.getElementById("userModal").classList.add("hidden");
      }

      // Demo Data for when Firebase is not configured
      function loadDemoData() {
        allUsers = generateDemoUsers();
        filteredUsers = [...allUsers];
        renderUsers();
        updateStats();
        updateConnectionStatus(false, "Using demo data");
      }

      function generateDemoUsers() {
        const demoUsers = [];
        const firstNames = [
          "John",
          "Jane",
          "Alice",
          "Bob",
          "Charlie",
          "Diana",
          "Eve",
          "Frank",
          "Grace",
          "Henry",
        ];
        const lastNames = [
          "Smith",
          "Johnson",
          "Williams",
          "Brown",
          "Jones",
          "Garcia",
          "Miller",
          "Davis",
          "Rodriguez",
          "Martinez",
        ];
        const devices = [
          "Samsung Galaxy S21",
          "Google Pixel 6",
          "OnePlus 9",
          "Xiaomi Mi 11",
          "Huawei P40",
          "iPhone 13",
          "Samsung Galaxy Note 20",
        ];
        const subscriptionTypes = ["FREE", "PREMIUM", "LIFETIME"];

        for (let i = 0; i < 25; i++) {
          const firstName =
            firstNames[Math.floor(Math.random() * firstNames.length)];
          const lastName =
            lastNames[Math.floor(Math.random() * lastNames.length)];
          const isSubscribed = Math.random() > 0.7;
          const createdAt =
            Date.now() - Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000);
          const lastLoginAt =
            Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000);

          demoUsers.push({
            uid: `demo_${i}_${Date.now()}`,
            displayName: `${firstName} ${lastName}`,
            email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`,
            photoUrl: `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=random`,
            subscribed: isSubscribed,
            subscriptionType: isSubscribed
              ? subscriptionTypes[Math.floor(Math.random() * 2) + 1]
              : "FREE",
            subscriptionStartDate: isSubscribed
              ? createdAt + Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000)
              : null,
            subscriptionEndDate: isSubscribed
              ? Date.now() +
                Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000)
              : null,
            createdAt: createdAt,
            lastLoginAt: lastLoginAt,
            deviceInfo: {
              deviceModel: devices[Math.floor(Math.random() * devices.length)],
              androidVersion: `${Math.floor(Math.random() * 5) + 8}.0`,
              appVersion: `1.${Math.floor(Math.random() * 10)}.${Math.floor(
                Math.random() * 10
              )}`,
              deviceId: `device_${i}`,
              fcmToken: `fcm_token_${i}`,
            },
            analytics: {
              totalLogins: Math.floor(Math.random() * 100) + 1,
              lastActiveDate: lastLoginAt,
              sessionCount: Math.floor(Math.random() * 50) + 1,
              averageSessionDuration: Math.floor(Math.random() * 3600) + 300,
              featuresUsed: ["keyboard", "translator", "settings"],
              referralSource: "organic",
            },
          });
        }

        return demoUsers;
      }

      async function checkFirebaseConnection() {
        try {
          if (window.db) {
            await loadUsersFromFirebase();
            updateConnectionStatus(true);
          } else {
            throw new Error("Firebase not initialized");
          }
        } catch (error) {
          console.error("Firebase connection failed:", error);
          updateConnectionStatus(false, error.message);
          showError("Failed to connect to Firebase: " + error.message);
          // Show config modal if connection fails
          document.getElementById("configModal").style.display = "flex";
        }
      }

      function updateConnectionStatus(connected, error = null) {
        const statusElement = document.getElementById("connectionStatus");
        if (connected) {
          statusElement.innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-200 text-green-800">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Connected to Firebase
                    </span>
                `;
          isConnected = true;
          document.getElementById("configModal").style.display = "none";
        } else {
          statusElement.innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-200 text-red-800">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                        ${
                          error === "Using demo data"
                            ? "Demo Mode"
                            : "Connection Failed"
                        }
                    </span>
                `;
          isConnected = false;
        }
      }

      async function loadUsersFromFirebase() {
        try {
          showLoading(true);
          hideError();

          const { collection, getDocs, query, orderBy } = window.firestore;
          const usersRef = collection(window.db, "users");
          const q = query(usersRef, orderBy("createdAt", "desc"));
          const snapshot = await getDocs(q);

          allUsers = [];
          snapshot.forEach((doc) => {
            const userData = doc.data();
            const user = normalizeUserData(userData, doc.id);
            allUsers.push(user);
          });

          filteredUsers = [...allUsers];
          renderUsers();
          updateStats();
          showLoading(false);

          console.log(`Loaded ${allUsers.length} users from Firebase`);
        } catch (error) {
          console.error("Error loading users:", error);
          showError("Failed to load users: " + error.message);
          showLoading(false);
        }
      }

      function normalizeUserData(userData, docId) {
        const user = {
          uid: userData.uid || userData.a || docId,
          displayName: userData.displayName || userData.b || "Unknown User",
          email: userData.email || userData.c || "No Email",
          photoUrl: userData.photoUrl || userData.d || null,
          subscribed:
            userData.subscribed !== undefined
              ? userData.subscribed
              : userData.g !== undefined
              ? userData.g
              : false,
          subscriptionType: userData.subscriptionType || userData.h || "FREE",
          subscriptionStartDate:
            userData.subscriptionStartDate || userData.i || null,
          subscriptionEndDate:
            userData.subscriptionEndDate || userData.j || null,
          createdAt: userData.createdAt || userData.e || Date.now(),
          lastLoginAt: userData.lastLoginAt || userData.f || Date.now(),
          deviceInfo: normalizeDeviceInfo(
            userData.deviceInfo || userData.k || {}
          ),
          analytics: normalizeAnalytics(userData.analytics || userData.l || {}),
        };

        return user;
      }

      function normalizeDeviceInfo(deviceInfo) {
        return {
          deviceModel:
            deviceInfo.deviceModel || deviceInfo.a || "Unknown Device",
          androidVersion:
            deviceInfo.androidVersion || deviceInfo.b || "Unknown",
          appVersion: deviceInfo.appVersion || deviceInfo.c || "Unknown",
          deviceId: deviceInfo.deviceId || deviceInfo.d || "Unknown",
          fcmToken: deviceInfo.fcmToken || deviceInfo.e || "",
        };
      }

      function normalizeAnalytics(analytics) {
        return {
          totalLogins: analytics.totalLogins || analytics.a || 0,
          lastActiveDate: analytics.lastActiveDate || analytics.b || Date.now(),
          sessionCount: analytics.sessionCount || analytics.c || 0,
          averageSessionDuration:
            analytics.averageSessionDuration || analytics.d || 0,
          featuresUsed: analytics.featuresUsed || analytics.e || [],
          referralSource: analytics.referralSource || analytics.f || "unknown",
        };
      }

      function showLoading(show) {
        const loadingState = document.getElementById("loadingState");
        const usersTable = document.getElementById("usersTable");

        if (show) {
          loadingState.classList.remove("hidden");
          usersTable.classList.add("hidden");
        } else {
          loadingState.classList.add("hidden");
          usersTable.classList.remove("hidden");
        }
      }

      function showError(message) {
        const errorState = document.getElementById("errorState");
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorState.classList.remove("hidden");
      }

      function hideError() {
        document.getElementById("errorState").classList.add("hidden");
      }

      function filterUsers() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const subscriptionFilter =
          document.getElementById("subscriptionFilter").value;
        const subscriptionTypeFilter = document.getElementById(
          "subscriptionTypeFilter"
        ).value;
        const dateFilter = document.getElementById("dateFilter").value;

        filteredUsers = allUsers.filter((user) => {
          const matchesSearch =
            !searchTerm ||
            user.displayName.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm);

          const matchesSubscription =
            !subscriptionFilter ||
            user.subscribed.toString() === subscriptionFilter;

          const matchesSubscriptionType =
            !subscriptionTypeFilter ||
            user.subscriptionType === subscriptionTypeFilter;

          const matchesDate =
            !dateFilter || checkDateFilter(user.createdAt, dateFilter);

          return (
            matchesSearch &&
            matchesSubscription &&
            matchesSubscriptionType &&
            matchesDate
          );
        });

        currentPage = 1;
        renderUsers();
        updateStats();
      }

      function checkDateFilter(timestamp, filter) {
        const now = moment();
        const date = moment(timestamp);

        switch (filter) {
          case "today":
            return date.isSame(now, "day");
          case "week":
            return date.isSame(now, "week");
          case "month":
            return date.isSame(now, "month");
          case "year":
            return date.isSame(now, "year");
          default:
            return true;
        }
      }

      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("subscriptionFilter").value = "";
        document.getElementById("subscriptionTypeFilter").value = "";
        document.getElementById("dateFilter").value = "";
        filterUsers();
      }

      function refreshData() {
        if (isConnected) {
          loadUsersFromFirebase();
        } else {
          loadDemoData();
        }
      }

      function updateStats() {
        const totalUsersEl = document.getElementById("totalUsers");
        const subscribedUsersEl = document.getElementById("subscribedUsers");
        const activeTodayEl = document.getElementById("activeToday");
        const newThisWeekEl = document.getElementById("newThisWeek");

        const totalUsers = filteredUsers.length;
        const subscribedUsers = filteredUsers.filter(
          (user) => user.subscribed
        ).length;

        const today = moment().startOf("day");
        const activeToday = filteredUsers.filter((user) =>
          moment(user.analytics.lastActiveDate).isAfter(today)
        ).length;

        const weekStart = moment().startOf("week");
        const newThisWeek = filteredUsers.filter((user) =>
          moment(user.createdAt).isAfter(weekStart)
        ).length;

        totalUsersEl.textContent = totalUsers;
        subscribedUsersEl.textContent = subscribedUsers;
        activeTodayEl.textContent = activeToday;
        newThisWeekEl.textContent = newThisWeek;
      }

      function renderUsers() {
        const tbody = document.getElementById("usersTableBody");
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

        tbody.innerHTML = "";

        if (paginatedUsers.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                <p class="text-lg font-medium">No users found</p>
                                <p class="text-sm">Try adjusting your search or filter criteria</p>
                            </div>
                        </td>
                    </tr>
                `;
          return;
        }

        paginatedUsers.forEach((user) => {
          const row = createUserRow(user);
          tbody.appendChild(row);
        });

        updatePagination();
      }

      function createUserRow(user) {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50";

        const subscriptionBadge = user.subscribed
          ? `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">${user.subscriptionType}</span>`
          : `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">FREE</span>`;

        const lastActive = moment(user.analytics.lastActiveDate);
        const isRecentlyActive = lastActive.isAfter(
          moment().subtract(24, "hours")
        );
        const activityBadge = isRecentlyActive
          ? `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>`
          : `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>`;

        row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            ${
                              user.photoUrl
                                ? `<img class="user-avatar" src="${user.photoUrl}" alt="${user.displayName}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGMkY0RjciLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMVY5QTQgNCAwIDAwMTYgNUg4QTQgNCAwIDAwNCA5VjIxIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4KPC9zdmc+'" />`
                                : `<div class="h-10 w-10 bg-gray-300 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-700">${user.displayName
                                      .charAt(0)
                                      .toUpperCase()}</span>
                                </div>`
                            }
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${
                              user.displayName
                            }</div>
                            <div class="text-sm text-gray-500">ID: ${user.uid.substring(
                              0,
                              8
                            )}...</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${user.email}</div>
                    <div class="text-sm text-gray-500">Joined: ${moment(
                      user.createdAt
                    ).format("MMM DD, YYYY")}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${subscriptionBadge}
                    ${
                      user.subscribed && user.subscriptionEndDate
                        ? `<div class="text-xs text-gray-500 mt-1">Expires: ${moment(
                            user.subscriptionEndDate
                          ).format("MMM DD, YYYY")}</div>`
                        : ""
                    }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${
                      user.deviceInfo.deviceModel
                    }</div>
                    <div class="text-sm text-gray-500">Android ${
                      user.deviceInfo.androidVersion
                    } • App ${user.deviceInfo.appVersion}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${activityBadge}
                    <div class="text-xs text-gray-500 mt-1">
                        Last: ${moment(user.lastLoginAt).fromNow()}<br>
                        Logins: ${user.analytics.totalLogins}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewUser('${
                      user.uid
                    }')">
                        View
                    </button>
                    <button class="text-green-600 hover:text-green-900" onclick="exportUserData('${
                      user.uid
                    }')">
                        Export
                    </button>
                </td>
            `;

        return row;
      }

      function updatePagination() {
        const totalItems = filteredUsers.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, totalItems);

        document.getElementById("showingStart").textContent =
          totalItems > 0 ? startIndex : 0;
        document.getElementById("showingEnd").textContent = endIndex;
        document.getElementById("showingTotal").textContent = totalItems;

        const prevButton = document.getElementById("prevPage");
        const nextButton = document.getElementById("nextPage");

        prevButton.disabled = currentPage <= 1;
        nextButton.disabled = currentPage >= totalPages;

        const pageNumbers = document.getElementById("pageNumbers");
        pageNumbers.innerHTML = "";

        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          pageButton.className = `px-3 py-1 text-sm rounded-md ${
            i === currentPage
              ? "bg-blue-500 text-white"
              : "bg-gray-200 text-gray-600 hover:bg-gray-300"
          }`;
          pageButton.onclick = () => changePage(i);
          pageNumbers.appendChild(pageButton);
        }
      }

      function changePage(page) {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          renderUsers();
        }
      }

      // User interaction functions
      function viewUser(uid) {
        const user = allUsers.find((u) => u.uid === uid);
        if (!user) return;

        const modalContent = document.getElementById("userModalContent");
        modalContent.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            ${
                              user.photoUrl
                                ? `<img class="w-16 h-16 rounded-full" src="${user.photoUrl}" alt="${user.displayName}">`
                                : `<div class="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center">
                                    <span class="text-xl font-medium text-gray-700">${user.displayName
                                      .charAt(0)
                                      .toUpperCase()}</span>
                                </div>`
                            }
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${
                              user.displayName
                            }</h4>
                            <p class="text-sm text-gray-500">${user.email}</p>
                            <p class="text-sm text-gray-500">User ID: ${
                              user.uid
                            }</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="text-sm font-medium text-gray-900 mb-3">Account Information</h5>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Status:</dt>
                                    <dd class="text-sm text-gray-900">${
                                      user.subscribed
                                        ? user.subscriptionType
                                        : "FREE"
                                    }</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Member Since:</dt>
                                    <dd class="text-sm text-gray-900">${moment(
                                      user.createdAt
                                    ).format("MMM DD, YYYY")}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Last Login:</dt>
                                    <dd class="text-sm text-gray-900">${moment(
                                      user.lastLoginAt
                                    ).format("MMM DD, YYYY HH:mm")}</dd>
                                </div>
                                ${
                                  user.subscribed && user.subscriptionEndDate
                                    ? `
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Subscription Expires:</dt>
                                    <dd class="text-sm text-gray-900">${moment(
                                      user.subscriptionEndDate
                                    ).format("MMM DD, YYYY")}</dd>
                                </div>
                                `
                                    : ""
                                }
                            </dl>
                        </div>

                        <div>
                            <h5 class="text-sm font-medium text-gray-900 mb-3">Device Information</h5>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Device:</dt>
                                    <dd class="text-sm text-gray-900">${
                                      user.deviceInfo.deviceModel
                                    }</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">Android Version:</dt>
                                    <dd class="text-sm text-gray-900">${
                                      user.deviceInfo.androidVersion
                                    }</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-600">App Version:</dt>
                                    <dd class="text-sm text-gray-900">${
                                      user.deviceInfo.appVersion
                                    }</dd>
                                </div>
                            </dl>
                        </div>
                    </div>

                    <div>
                        <h5 class="text-sm font-medium text-gray-900 mb-3">Usage Analytics</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-gray-900">${
                                  user.analytics.totalLogins
                                }</div>
                                <div class="text-sm text-gray-600">Total Logins</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-gray-900">${
                                  user.analytics.sessionCount
                                }</div>
                                <div class="text-sm text-gray-600">Sessions</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-gray-900">${Math.floor(
                                  user.analytics.averageSessionDuration / 60
                                )}m</div>
                                <div class="text-sm text-gray-600">Avg Session</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-gray-900">${moment(
                                  user.analytics.lastActiveDate
                                ).fromNow()}</div>
                                <div class="text-sm text-gray-600">Last Active</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.getElementById("userModal").classList.remove("hidden");
        document.getElementById("userModal").style.display = "flex";
      }

      function exportUserData(uid) {
        const user = allUsers.find((u) => u.uid === uid);
        if (!user) return;

        const userData = {
          uid: user.uid,
          displayName: user.displayName,
          email: user.email,
          subscribed: user.subscribed,
          subscriptionType: user.subscriptionType,
          createdAt: moment(user.createdAt).format("YYYY-MM-DD HH:mm:ss"),
          lastLoginAt: moment(user.lastLoginAt).format("YYYY-MM-DD HH:mm:ss"),
          deviceInfo: user.deviceInfo,
          analytics: user.analytics,
        };

        const blob = new Blob([JSON.stringify(userData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `user_${user.uid}_${moment().format("YYYY-MM-DD")}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportToCSV() {
        const headers = [
          "UID",
          "Display Name",
          "Email",
          "Subscribed",
          "Subscription Type",
          "Created At",
          "Last Login",
          "Device Model",
          "Android Version",
          "App Version",
          "Total Logins",
          "Session Count",
        ];

        const rows = filteredUsers.map((user) => [
          user.uid,
          user.displayName,
          user.email,
          user.subscribed,
          user.subscriptionType,
          moment(user.createdAt).format("YYYY-MM-DD HH:mm:ss"),
          moment(user.lastLoginAt).format("YYYY-MM-DD HH:mm:ss"),
          user.deviceInfo.deviceModel,
          user.deviceInfo.androidVersion,
          user.deviceInfo.appVersion,
          user.analytics.totalLogins,
          user.analytics.sessionCount,
        ]);

        let csvContent = headers.join(",") + "\n";
        rows.forEach((row) => {
          csvContent += row.map((field) => `"${field}"`).join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `users_export_${moment().format("YYYY-MM-DD")}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
